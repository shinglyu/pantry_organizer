<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Mocha Tests</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/mocha/8.4.0/mocha.min.css" />
</head>
<body>
    <div id="mocha"></div>
    <hr>
    <h1>My Pantry</h1>
    <input type="text" id="name" name="name">
    <label for="name">Name</label>
    <br>
    <input type="text" id="expiry-date-text" name="expiry-date-text" placeholder="e.g. 2024年1月1日">
    <label for="expiry-date-text">Expiry Date</label>
    <br>
    <input type="date" id="expiry-date" name="expiry-date">
    <label for="expiry-date">Expiry Date (manual)</label>
    <br>
    <small>Item will be added automatically when a expiry date is picked. Input the date in natural language in the auto field (works great for voice typing), or manually pick the date using the manual date picker.</small>
    <ul id="pantry-list">
        <!-- Items will be dynamically inserted here -->
    </ul>
    <br>
    <button id="export">Export</button>
    <button id="import">Import</button>


    <script src="https://cdnjs.cloudflare.com/ajax/libs/mocha/8.4.0/mocha.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chai/4.3.4/chai.min.js"></script>
    <script>mocha.setup('bdd')</script>

    <!-- Include your test files here -->
    <script src="index.js"></script>

    <script>
        let localStorageBackup = null;

        before(function() {
            // Backup localStorage before all tests
            localStorageBackup = localStorage.getItem('pantryItems');
            localStorage.clear();
        });

        after(function() {
            // Restore localStorage after all tests
            localStorage.setItem('pantryItems', localStorageBackup);
        });

        describe('addPantryItem', function() {
            it('should add an item to the pantry', function() {
                localStorage.clear();
                addPantryItem('apple', '2025-01-01');
                localStorage.getItem('pantryItems').should.equal('[{"name":"apple","expiryDate":"2025-01-01"}]');
            });
            it('Add the item to the pantry, ordered by the expiary date', function() {
                localStorage.clear();
                addPantryItem('apple', '2025-01-01');
                addPantryItem('banana', '2024-03-12');
                localStorage.getItem('pantryItems').should.equal(
                    '[{"name":"banana","expiryDate":"2024-03-12"},{"name":"apple","expiryDate":"2025-01-01"}]'
                );
            });
        });
        describe('removePantryItem', function() {
            it('should remove an item from the pantry', function() {
                localStorage.clear();
                localStorage.setItem('pantryItems', '[{"name":"apple","expiryDate":"2025-01-01"}]');
                removePantryItem(0);
                localStorage.getItem('pantryItems').should.equal('[]')
            });
        });
        describe('render', function() {
            it('should reorder the pantryList in localStorage if required', function() {
                localStorage.clear();
                // Order is reversed
                localStorage.setItem('pantryItems', 
                    '[{"name":"apple","expiryDate":"2025-01-01"},{"name":"banana","expiryDate":"2024-03-12"}]'
                )
                render()
                localStorage.getItem('pantryItems').should.equal('[{"name":"banana","expiryDate":"2024-03-12"},{"name":"apple","expiryDate":"2025-01-01"}]')
            });
        });
        describe('parseQuickAdd', function() {
            it('should split the name and date from standard format string with name and date', function() {
                const parsedItem = parseQuickAdd('蘋果2025年1月1日')
                parsedItem.should.deep.equal(
                    {name: '蘋果', expiryDate: '2025-01-01'}
                )
            });
            it('works with only dates', function() {
                const parsedItem = parseQuickAdd('2025年1月1日')
                parsedItem.should.deep.equal(
                    {name: '', expiryDate: '2025-01-01'}
                )
            });
        });
        chai.should();
        mocha.run();
    </script>
</body>
</html>
